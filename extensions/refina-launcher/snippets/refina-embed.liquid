{%- comment -%}
Refina Theme App Embed (real embed)
- Injects versioned /apps/refina/concierge.(css|js)
- Applies Admin tokens inline so colors reflect Settings immediately
- Editor-safe: opens App Proxy in a new tab inside Theme Editor/Admin
{%- endcomment -%}

{%- assign ver = block.settings.asset_version | default: 'v3' -%}

<link rel="stylesheet" href="/apps/refina/concierge.css?v={{ ver }}">
<script type="module" src="/apps/refina/concierge.js?v={{ ver }}" defer></script>

{%- assign page_type = template.name | downcase -%}
<div
  data-refina-launcher
  data-embed-ver="{{ ver }}"
  data-side="{{ block.settings.side | default: 'right' }}"
  data-offset="{{ block.settings.offset | default: 24 }}"
  data-brand-color="{{ block.settings.brand_color | default: '#d10000' }}"
  data-show-mobile="{{ block.settings.show_mobile | default: true }}"
  data-page-type="{{ page_type }}"
  data-hide-on-product="{{ block.settings.hide_on_product | default: false }}"
  data-hide-on-cart="{{ block.settings.hide_on_cart | default: false }}"
  data-shop="{{ shop.permanent_domain }}"
  data-proxy-path="{{ block.settings.proxy_path | default: 'apps/refina' }}"
  data-z-index="{{ block.settings.z_index | default: 2147483646 }}"
  data-open-on-load="{{ block.settings.open_on_load | default: false }}"
></div>

<script>
/* A) Apply tokens immediately so CSS vars reflect Admin Settings */
(() => {
  async function fetchSettings() {
    try {
      const r = await fetch("/apps/refina/v1/settings", { headers: { "Accept":"application/json" }});
      if (!r.ok) throw new Error("settings_fetch_failed:"+r.status);
      return r.json();
    } catch { return null; }
  }
  function applyTokens(tokens) {
    if (!tokens || typeof tokens !== "object") return;
    const targets = [document.documentElement, (document.querySelector(".rf-root") || document.body)];
    for (const el of targets) {
      if (!el || !el.style) continue;
      for (const k in tokens) if (Object.prototype.hasOwnProperty.call(tokens, k) && k[0]==='-') {
        try { el.style.setProperty(k, String(tokens[k])); } catch {}
      }
    }
  }
  fetchSettings().then(s => applyTokens(s && s.tokens));
})();

/* B) Launcher (editor-safe) */
(() => {
  const q = (s, r=document) => r.querySelector(s);
  const qa = (s, r=document) => Array.from(r.querySelectorAll(s));
  if (window.__REFINA_LAUNCHER_LOADED__) return;
  window.__REFINA_LAUNCHER_LOADED__ = true;

  function initAll(){ qa('[data-refina-launcher]').forEach(initOne); }

  function initOne(root){
    if (!root || root.dataset.initialized === 'true') return;

    const side = root.dataset.side === 'left' ? 'left' : 'right';
    const offset = Math.max(0, parseInt(root.dataset.offset || '24', 10));
    const brand = root.dataset.brandColor || root.dataset.brand || '#d10000';
    const showMobile = String(root.dataset.showMobile).toLowerCase() !== 'false';
    const pageType = (root.dataset.pageType || '').toLowerCase();
    const hideOnProduct = String(root.dataset.hideOnProduct).toLowerCase() === 'true';
    const hideOnCart = String(root.dataset.hideOnCart).toLowerCase() === 'true';
    const shopDomain = root.dataset.shop || (window.Shopify && window.Shopify.shop) || '';
    const proxyPath = (root.dataset.proxyPath || 'apps/refina').replace(/^\/+/, '');
    const zIndex = parseInt(root.dataset.zIndex || '2147483646', 10);
    const openOnLoad = String(root.dataset.openOnLoad).toLowerCase() === 'true';

    if (!shopDomain) { root.dataset.initialized = 'true'; return; }
    if ((hideOnProduct && pageType === 'product') || (hideOnCart && pageType === 'cart')) {
      root.dataset.initialized = 'true'; return;
    }

    const isMobile = () => window.matchMedia('(max-width: 640px)').matches;
    if (!showMobile && isMobile()) { root.dataset.initialized = 'true'; return; }

    if (!q('#refina-launcher-style')) {
      const style = document.createElement('style');
      style.id = 'refina-launcher-style';
      style.textContent = `
        :root { --refina-safe-bottom: env(safe-area-inset-bottom, 0px); --refina-safe-top: env(safe-area-inset-top, 0px); }
        .refina-launcher-btn{
          position:fixed;${side}:16px;bottom:calc(${offset}px + var(--refina-safe-bottom));display:inline-flex;align-items:center;gap:8px;
          padding:10px 14px;border-radius:9999px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,sans-serif;
          font-weight:600;font-size:14px;color:#fff;background:${brand};border:0;cursor:pointer;
          box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:${zIndex}
        }
        .refina-launcher-btn:focus{outline:2px solid #000;outline-offset:2px}
        .refina-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:${zIndex};display:flex;align-items:center;justify-content:center}
        .refina-modal{position:relative;width:min(92vw,980px);height:min(92vh,720px);background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.35)}
        .refina-modal iframe{width:100%;height:100%;border:0;display:block;background:#fff}
        .refina-modal-close{position:absolute;top:calc(10px + var(--refina-safe-top));${side==='left'?'right':'left'}:10px;background:rgba(17,17,17,.75);color:#fff;border:0;border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
        @media (max-width:640px){.refina-launcher-btn{${side}:12px;padding:10px 12px}.refina-modal{width:100vw;height:100vh;border-radius:0}.refina-modal-close{top:calc(12px + var(--refina-safe-top));${side==='left'?'right':'left'}:12px}}
      `;
      document.head.appendChild(style);
    }

    const btn = document.createElement('button');
    btn.className = 'refina-launcher-btn';
    btn.type = 'button';
    btn.setAttribute('aria-label', 'Open shopping concierge');
    btn.innerHTML = `<span>Refina</span>`;
    document.body.appendChild(btn);

    const applyPos = () => {
      btn.style.bottom = `calc(${offset}px + var(--refina-safe-bottom))`;
      btn.style[side] = '16px';
      btn.style.display = (!showMobile && isMobile()) ? 'none' : 'inline-flex';
    };
    applyPos(); window.addEventListener('resize', applyPos);

    let overlay = null, lastFocus = null;

    function buildIframeUrl() {
      const base = new URL(`https://${shopDomain}/${proxyPath}`);
      base.searchParams.set('source', 'launcher');
      try { if (localStorage.getItem('refinaDev') === '1') base.searchParams.set('dev', '1'); } catch {}
      return base.toString();
    }

    function openModal() {
      if (overlay) return;
      lastFocus = document.activeElement;

      overlay = document.createElement('div');
      overlay.className = 'refina-modal-overlay';
      overlay.setAttribute('role', 'dialog'); overlay.setAttribute('aria-modal', 'true');

      const modal = document.createElement('div'); modal.className = 'refina-modal';

      const close = document.createElement('button');
      close.className = 'refina-modal-close'; close.type = 'button';
      close.textContent = 'Close âœ•'; close.setAttribute('aria-label', 'Close concierge');
      close.addEventListener('click', closeModal);

      const iframe = document.createElement('iframe');
      iframe.src = buildIframeUrl();
      iframe.title = 'Refina concierge';

      overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });

      modal.appendChild(close); modal.appendChild(iframe);
      overlay.appendChild(modal); document.body.appendChild(overlay);
      setTimeout(() => close.focus(), 0);

      overlay.addEventListener('keydown', (e) => {
        if (e.key !== 'Tab') return;
        const focusables = [close, iframe];
        const idx = focusables.indexOf(document.activeElement);
        if (e.shiftKey && (idx <= 0)) { e.preventDefault(); focusables[focusables.length - 1].focus(); }
        else if (!e.shiftKey && (idx === focusables.length - 1)) { e.preventDefault(); focusables[0].focus(); }
      });
    }

    function closeModal() {
      if (!overlay) return;
      overlay.remove(); overlay = null;
      if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus(); else btn.focus();
    }

    const IN_THEME_EDITOR = !!(window.Shopify && window.Shopify.designMode);
    const IN_ADMIN = /(^|\.)admin\.shopify\.com$/.test((window.top && window.top.location && window.top.location.hostname) || "");

    btn.addEventListener('click', () => {
      if (IN_THEME_EDITOR || IN_ADMIN) {
        const url = buildIframeUrl();
        try { window.open(url, '_blank', 'noopener'); } catch (_) { location.href = url; }
      } else {
        openModal();
      }
    });

    if (openOnLoad && !(IN_THEME_EDITOR || IN_ADMIN)) setTimeout(openModal, 0);

    root.dataset.initialized = 'true';
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initAll, { once: true });
  else initAll();
})();
</script>

{% schema %}
{
  "name": "Refina Concierge (Embed)",
  "target": "body",
  "settings": [
    { "type": "text", "id": "asset_version", "label": "Asset version (cache buster)", "default": "v3" },
    { "type": "select", "id": "side", "label": "Launcher side", "default": "right", "options": [
      { "value": "left", "label": "Left" }, { "value": "right", "label": "Right" }
    ]},
    { "type": "number", "id": "offset", "label": "Bottom offset (px)", "default": 24 },
    { "type": "color", "id": "brand_color", "label": "Launcher brand color", "default": "#d10000" },
    { "type": "checkbox", "id": "show_mobile", "label": "Show on mobile", "default": true },
    { "type": "checkbox", "id": "hide_on_product", "label": "Hide on product pages", "default": false },
    { "type": "checkbox", "id": "hide_on_cart", "label": "Hide on cart page", "default": false },
    { "type": "text", "id": "proxy_path", "label": "App Proxy subpath", "default": "apps/refina" },
    { "type": "number", "id": "z_index", "label": "Z-index", "default": 2147483646 },
    { "type": "checkbox", "id": "open_on_load", "label": "Open on page load", "default": false }
  ],
  "enabled_on": { "templates": ["*"] }
}
{% endschema %}
