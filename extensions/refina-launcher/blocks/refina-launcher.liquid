{%- comment -%}
Refina Theme App Embed (Launcher, production)
- Loads concierge assets via Shopify App Proxy (versioned for cache-busting)
- Outputs a single launcher mount with data-* config from Theme App Embed
- Editor-safe: opens App Proxy in a new tab inside Theme Editor/Admin
{%- endcomment -%}

{%- assign ver = block.settings.asset_version | default: 'v3' -%}

{{ 'concierge.css' | asset_url | stylesheet_tag }}
<script type="module" src="{{ 'concierge.js' | asset_url }}" defer></script>

{%- assign page_type = template.name | downcase -%}
<div
  data-refina-launcher
  data-heading="{{ block.settings.heading }}"
  data-subheading="{{ block.settings.subheading }}"
  data-cta-text="{{ block.settings.cta_text }}"
  data-primary-color="{{ block.settings.primary_color }}"
  data-accent-color="{{ block.settings.accent_color }}"
  data-border-radius="{{ block.settings.border_radius }}"
  data-button-style="{{ block.settings.button_style }}"
  data-grid-columns="{{ block.settings.grid_columns }}"
  data-side="{{ block.settings.side }}"
  data-offset="{{ block.settings.offset }}"
  data-show-mobile="{{ block.settings.show_mobile }}"
  data-hide-on-product="{{ block.settings.hide_on_product }}"
  data-hide-on-cart="{{ block.settings.hide_on_cart }}"
  data-open-on-load="{{ block.settings.open_on_load }}"
  data-show-badges="{{ block.settings.show_badges }}"
  data-show-prices="{{ block.settings.show_prices }}"
  data-shop="{{ shop.permanent_domain }}"
  data-page-type="{{ page_type }}"
></div>

<script>
/* Launcher (editor-safe) */
(() => {
  const q = (s, r=document) => r.querySelector(s);
  const qa = (s, r=document) => Array.from(r.querySelectorAll(s));
  if (window.__REFINA_LAUNCHER_LOADED__) return;
  window.__REFINA_LAUNCHER_LOADED__ = true;

  function initAll(){ qa('[data-refina-launcher]').forEach(initOne); }

  function initOne(root){
    if (!root || root.dataset.initialized === 'true') return;

    // --- Read all settings from the data attributes ---
    const settings = root.dataset;
    const side = settings.side === 'left' ? 'left' : 'right';
    const offset = Math.max(0, parseInt(settings.offset || '24', 10));
    const showMobile = String(settings.showMobile).toLowerCase() !== 'false';
    const pageType = (settings.pageType || '').toLowerCase();
    const hideOnProduct = String(settings.hideOnProduct).toLowerCase() === 'true';
    const hideOnCart = String(settings.hideOnCart).toLowerCase() === 'true';
    const shopDomain = settings.shop || (window.Shopify && window.Shopify.shop) || '';
    const zIndex = 2147483646; // Keep z-index high and non-configurable for simplicity
    const openOnLoad = String(settings.openOnLoad).toLowerCase() === 'true';

    // New settings for text and color
    const ctaText = settings.ctaText || 'Ask Refina';
    const primaryColor = settings.primaryColor || '#111827';

    if (!shopDomain) { root.dataset.initialized = 'true'; return; }
    if ((hideOnProduct && pageType === 'product') || (hideOnCart && pageType === 'cart')) {
      root.dataset.initialized = 'true'; return;
    }

    const isMobile = () => window.matchMedia('(max-width: 640px)').matches;
    if (!showMobile && isMobile()) { root.dataset.initialized = 'true'; return; }

    if (!q('#refina-launcher-style')) {
      const style = document.createElement('style');
      style.id = 'refina-launcher-style';
      style.textContent = `
        :root {
          --refina-safe-bottom: env(safe-area-inset-bottom, 0px);
          --refina-safe-top: env(safe-area-inset-top, 0px);
          --rf-primary-color: ${primaryColor};
        }
        .refina-launcher-btn {
          position:fixed; ${side}:16px; bottom:calc(${offset}px + var(--refina-safe-bottom)); display:inline-flex; align-items:center; gap:8px;
          padding:10px 14px; border-radius:9999px; font-family:-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, sans-serif;
          font-weight:600; font-size:14px; color:#fff; background:var(--rf-primary-color); border:0; cursor:pointer;
          box-shadow:0 8px 24px rgba(0,0,0,.18); z-index:${zIndex};
        }
        .refina-launcher-btn:focus { outline:2px solid var(--rf-primary-color); outline-offset:2px; }
        .refina-modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:${zIndex}; display:flex; align-items:center; justify-content:center; }
        .refina-modal { position:relative; width:min(92vw,980px); height:min(92vh,720px); background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.35); }
        .refina-modal iframe { width:100%; height:100%; border:0; display:block; background:#fff; }
        .refina-modal-close { position:absolute; top:calc(10px + var(--refina-safe-top)); ${side === 'left' ? 'right' : 'left'}:10px; background:rgba(17,17,17,.75); color:#fff; border:0; border-radius:8px; padding:6px 10px; font-size:13px; cursor:pointer; }
        @media (max-width:640px) {
          .refina-launcher-btn { ${side}:12px; padding:10px 12px; }
          .refina-modal { width:100vw; height:100vh; border-radius:0; }
          .refina-modal-close { top:calc(12px + var(--refina-safe-top)); ${side === 'left' ? 'right' : 'left'}:12px; }
        }
      `;
      document.head.appendChild(style);
    }

    const btn = document.createElement('button');
    btn.className = 'refina-launcher-btn';
    btn.type = 'button';
    btn.setAttribute('aria-label', 'Open shopping concierge');
    btn.innerHTML = `<span>${ctaText}</span>`;
    document.body.appendChild(btn);

    const applyPos = () => {
      btn.style.bottom = `calc(${offset}px + var(--refina-safe-bottom))`;
      btn.style[side] = '16px';
      btn.style.display = (!showMobile && isMobile()) ? 'none' : 'inline-flex';
    };
    applyPos(); window.addEventListener('resize', applyPos);

    let overlay = null, lastFocus = null;

    function buildIframeUrl() {
      const base = new URL(`https://${shopDomain}/apps/refina`);
      // Pass all theme settings to the modal as URL parameters
      for (const key in settings) {
        if (Object.prototype.hasOwnProperty.call(settings, key)) {
          // Convert camelCase to kebab-case for the URL param
          const paramKey = key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`);
          base.searchParams.set(paramKey, settings[key]);
        }
      }
      base.searchParams.set('source', 'launcher');
      try { if (localStorage.getItem('refinaDev') === '1') base.searchParams.set('dev', '1'); } catch {}
      return base.toString();
    }

    function openModal() {
      if (overlay) return;
      lastFocus = document.activeElement;

      overlay = document.createElement('div');
      overlay.className = 'refina-modal-overlay';
      overlay.setAttribute('role', 'dialog'); overlay.setAttribute('aria-modal', 'true');

      const modal = document.createElement('div'); modal.className = 'refina-modal';

      const close = document.createElement('button');
      close.className = 'refina-modal-close'; close.type = 'button';
      close.textContent = 'Close ✕'; close.setAttribute('aria-label', 'Close concierge');
      close.addEventListener('click', closeModal);

      const iframe = document.createElement('iframe');
      iframe.src = buildIframeUrl();
      iframe.title = 'Refina concierge';

      overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });

      modal.appendChild(close); modal.appendChild(iframe);
      overlay.appendChild(modal); document.body.appendChild(overlay);
      setTimeout(() => close.focus(), 0);

      overlay.addEventListener('keydown', (e) => {
        if (e.key !== 'Tab') return;
        const focusables = [close, iframe];
        const idx = focusables.indexOf(document.activeElement);
        if (e.shiftKey && (idx <= 0)) { e.preventDefault(); focusables[focusables.length - 1].focus(); }
        else if (!e.shiftKey && (idx === focusables.length - 1)) { e.preventDefault(); focusables[0].focus(); }
      });
    }

    function closeModal() {
      if (!overlay) return;
      overlay.remove(); overlay = null;
      if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus(); else btn.focus();
    }

    // Editor-safe: in Theme Editor/Admin, open App Proxy in a new tab instead of iframing (XFO)
    const IN_THEME_EDITOR = !!(window.Shopify && window.Shopify.designMode);
    const IN_ADMIN = /(^|\.)admin\.shopify\.com$/.test((window.top && window.top.location && window.top.location.hostname) || "");

    btn.addEventListener('click', () => {
      if (IN_THEME_EDITOR || IN_ADMIN) {
        const url = buildIframeUrl();
        try { window.open(url, '_blank', 'noopener'); } catch (_) { location.href = url; }
      } else {
        openModal();
      }
    });

    if (openOnLoad && !(IN_THEME_EDITOR || IN_ADMIN)) setTimeout(openModal, 0);

    root.dataset.initialized = 'true';
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initAll, { once: true });
  else initAll();
})();
</script>

{% schema %}
{
  "name": "Refina Launcher",
  "target": "body",
  "settings": [
    { "type": "header", "content": "Content" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Find the perfect routine" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Tell us your concern and we’ll match expert picks." },
    { "type": "text", "id": "cta_text", "label": "Launcher Button Text", "default": "Ask Refina" },

    { "type": "header", "content": "Appearance" },
    { "type": "color", "id": "primary_color", "label": "Primary Color (Buttons)", "default": "#111827" },
    { "type": "color", "id": "accent_color", "label": "Accent Color (Highlights)", "default": "#10B981" },
    { "type": "select", "id": "border_radius", "label": "Border Radius", "options": [
        { "value": "sm", "label": "Small" },
        { "value": "md", "label": "Medium" },
        { "value": "lg", "label": "Large" },
        { "value": "2xl", "label": "2XL" }
    ], "default": "lg"},
    { "type": "select", "id": "button_style", "label": "Button Style", "options": [
        { "value": "solid", "label": "Solid" },
        { "value": "outline", "label": "Outline" }
    ], "default": "solid"},
    { "type": "range", "id": "grid_columns", "label": "Product Grid Columns", "min": 2, "max": 4, "step": 1, "default": 3 },

    { "type": "header", "content": "Behavior & Visibility" },
    { "type": "select", "id": "side", "label": "Launcher Position", "default": "right", "options": [
        { "value": "left", "label": "Left" }, { "value": "right", "label": "Right" }
    ]},
    { "type": "number", "id": "offset", "label": "Bottom Offset (px)", "default": 24 },
    { "type": "checkbox", "id": "show_mobile", "label": "Show on mobile", "default": true },
    { "type": "checkbox", "id": "hide_on_product", "label": "Hide on product pages", "default": false },
    { "type": "checkbox", "id": "hide_on_cart", "label": "Hide on cart page", "default": false },
    { "type": "checkbox", "id": "open_on_load", "label": "Open on page load", "default": false },
    { "type": "checkbox", "id": "show_badges", "label": "Show product badges", "default": true },
    { "type": "checkbox", "id": "show_prices", "label": "Show product prices", "default": true }
  ],
  "enabled_on": { "templates": ["*"] }
}
{% endschema %}